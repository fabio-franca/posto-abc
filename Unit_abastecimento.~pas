unit Unit_abastecimento;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Mask, Buttons, ComCtrls, ExtCtrls, DB, ADODB;

type
  TForm_abastecimento = class(TForm)
    cb_bomba: TComboBox;
    Label1: TLabel;
    Label2: TLabel;
    btn_fechar: TBitBtn;
    edt_litro: TMaskEdit;
    Label3: TLabel;
    Label4: TLabel;
    dt_abastecimento: TDateTimePicker;
    ADOQuery_aux: TADOQuery;
    Bevel1: TBevel;
    btn_salvar: TBitBtn;
    edt_valor: TEdit;
    edt_novo: TEdit;
    procedure btn_fecharClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure cb_bombaChange(Sender: TObject);
    procedure btn_salvarClick(Sender: TObject);
    procedure edt_valorEnter(Sender: TObject);
    procedure edt_valorExit(Sender: TObject);
  private
    { Private declarations }
    function soma (a,b : double) : double;
  public
    { Public declarations }
    id_bomba: string;
    function formata_valor(valor, destino: string): string;
  end;

var
  Form_abastecimento: TForm_abastecimento;
  num_bomba: integer;
  deu_erro: boolean;
implementation

uses Unit1;

{$R *.dfm}

procedure TForm_abastecimento.btn_fecharClick(Sender: TObject);
begin
 Close;
end;


procedure TForm_abastecimento.FormShow(Sender: TObject);
begin
   edt_valor.Text := '';
   edt_novo.Text := '';
   cb_bomba.Clear;
   dt_abastecimento.Date := Date;

   //Monta o select do combo bomba
   ADOQuery_aux.SQL.Text := ' SELECT DESCRICAO FROM BOMBAS ORDER BY DESCRICAO ';

   ADOQuery_aux.Open;

   //Enquanto não chegar no final da query faça
    while not ADOQuery_aux.Eof do
      begin
       //Adiciona ao combobox o nome da bomba do registro corrente
       cb_bomba.Items.Add(ADOQuery_aux.fieldbyname('DESCRICAO').AsString);
       //Passa para o próximo registro da query
       ADOQuery_aux.Next;
      end;

  ADOQuery_aux.Close;
end;

procedure TForm_abastecimento.cb_bombaChange(Sender: TObject);
begin
  ADOQuery_aux.SQL.Text:='SELECT ID_BOMBA FROM BOMBAS '+
                          'WHERE DESCRICAO = '+ QuotedStr(cb_bomba.Text);
  //Abre a query
  adoquery_aux.Open;
  //Atribui o valor obtido à variável
  num_bomba := ADOQuery_aux.fieldbyname('ID_BOMBA').AsInteger;
  //Fecha a query
  ADOQuery_aux.Close;
end;

function TForm_abastecimento.soma(a,b:double) : double;
var c: double;
begin
  c := a+b;
  result := c;
end;

function TForm_abastecimento.formata_valor(valor, destino: string): string;
var valor_formatado: string;
    i: integer;
begin
  //Verifica os parâmetros
  if(valor='') or (destino='') then
    begin
      result:= '';
      exit;
    end;
  valor_formatado:= valor;

  //Apaga os caracteres do símbolo monetário e o ponto
  Delete(valor_formatado,pos('R', valor_formatado),1);
  Delete(valor_formatado,pos('$', valor_formatado),1);
  Delete(valor_formatado,pos('.', valor_formatado),1);

  //Tira os espaços
  valor_formatado:= trim(valor_formatado);
  
  //Retorna o valor formtado de acordo com o destino
  if destino='T' then
    result:= FormatCurr('R$ #,##0.00', StrToCurr(valor_formatado))
  else if destino = 'E' then
    result:= valor_formatado
  else if destino = 'B' then
    begin
      //Varre a string para substituir a vírgula por ponto
      for i:=1 to Length(valor_formatado) do
      begin
        if valor_formatado[i] = ',' then
        valor_formatado[i]:= '.';
      end;
      result:= valor_formatado;
    end;
end;

procedure TForm_abastecimento.btn_salvarClick(Sender: TObject);
var data_abastecimento, edt_modificado: string;
    valor, percentual, valorFinal: currency;
    i: integer;
begin
   valor := StrToCurr(edt_valor.Text);
   percentual := (13/100);
   valorFinal := valor + (percentual * valor);
   edt_modificado := CurrToStr(valorFinal);
   edt_novo.Text := edt_modificado;
   edt_novo.Text := StringReplace(edt_novo.Text, ',', '.', [rfReplaceAll, rfIgnoreCase]);

   //FormatCurr('R$ #,##0.00', StrToCurr(edt_modificado));
   //for i:=1 to Length(edt_modificado) do
     // begin
       // if edt_modificado[i] = ',' then
       // edt_modificado[i]:= '.';
      //end;


  if(trim(cb_bomba.Text)='') or (trim(edt_litro.Text)='')
          or (trim(edt_valor.Text)='') then
    begin
      Showmessage('Todos os campos são obrigatórios!')
    end
  else
    begin
      Form_principal.ConexaoBD.BeginTrans;
      data_abastecimento := FormatDateTime('mm/dd/yyyy',dt_abastecimento.Date);
      ADOQuery_aux.SQL.Text := ' INSERT INTO ABASTECIMENTO (ID_BOMBA_ABASTECIMENTO, LITROS, VALOR, DATA_ABASTECIMENTO) VALUES ' +
                               ' ( ' + IntToStr(num_bomba) +
                               ' , '+ QuotedStr(edt_litro.Text)+ ' , ' + formata_valor(edt_novo.Text,'B') +
                               ' , ' + QuotedStr(data_abastecimento)+ ')';
      try
        //Executa o comando SQL
        ADOQuery_aux.ExecSQL;
        deu_erro := false;
      except
        on E: Exception do
        begin
          deu_erro:= true;
          Showmessage('Ocorreu o seguinte erro: ' + E.Message);
        end;
      end;

      if deu_erro = false then
        begin
          Form_principal.ConexaoBD.CommitTrans;

          Showmessage('Registro salvo com sucesso!');
          cb_bomba.ItemIndex:= -1;
          edt_litro.Clear;
          edt_valor.Clear;
          dt_abastecimento.Date := Date;
        end
      else
        begin
          Form_principal.ConexaoBD.RollbackTrans;
        end;
    end
end;

procedure TForm_abastecimento.edt_valorEnter(Sender: TObject);
begin
  //Quando recebe o foco do cursor, aplica o parâmetro E
  edt_valor.Text:= formata_valor(edt_valor.Text,'E');
end;

procedure TForm_abastecimento.edt_valorExit(Sender: TObject);
begin
  //Quando perde o foco do cursor, aplica o parâmetro T
  edt_valor.Text:= formata_valor(edt_valor.Text,'T');
end;

end.
